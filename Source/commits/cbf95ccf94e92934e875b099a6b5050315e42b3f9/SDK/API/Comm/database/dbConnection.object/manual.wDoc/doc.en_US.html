<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd">
<html><body><div class="wDoc">
<div class="header"></div>
<div class="body">
<h1>Database Connection Manager</h1>
<p>This class is responsible for connecting to a database, executing queries and transactions and fetching results.</p>
<p>At the moment it supports only MySQL connector.</p>
<h2>Examples of use</h2>
<p>Here we provide some examples to understand how this class works and what would be a good guide on how to use it.</p>
<h3>Connecting to a MySQL Server</h3>
<div class="code">
	<pre>// We assume that the class is importer and we use it
use \API\Comm\database\dbConnection;

// Initialize a connection object
// We initialize the connection as MySQL type
$dbc = new dbConnection($dbType = "MySQL", $host = "mysql.host", $database = "database_name", $username = "db_username", $password = "db_user_pwd");</pre>
</div>
<h3>Executing simple select queries</h3>
<p>Using this connection, we can execute a simple query or a set of queries as transaction. In the following example we will see how we can execute a simple selection query and read the results.</p>
<div class="code">
	<pre>// Create a selection query
$query = "SELECT * FROM users";

// Execute the result to get a mysqli result (in case of MySQL)
$result = $dbc-&gt;execute($query);
// We can fetch each result
while ($user = $dbc-&gt;fetch($result))
{
	// Do something with user
}

// Or fetch all at once in one array
$allUsers = $dbc-&gt;fetch($result, $fetchAll = TRUE);
foreach ($allUsers as $user)
{
	// Do something with user
}</pre>
</div>
<h3>Executing queries with parameters</h3>
<p>The dbConnection object also allows us to perform queries with attributes. Using attributes, we avoid SQL injection because the engine will escape all non-numeric attributes.</p>
<div class="code">
	<pre>// Adding a new user to the database
// We insert two attributes in the query by using {attr_name} or %{attr_name}
// Attributes allow the engine to escape non-numeric values

// Create the query with attributes
$query = "INSERT INTO users (username, password) VALUES ({username}, {password});";

// Set attributes values as a key-value array
$attributes = array();
$attributes['username'] = "John";
$attributes['password'] = "asdQWE!@#";

// Execute the query given an array of attributes
$result = $dbc-&gt;execute($query, $attributes);
	</pre>
</div>
<h3>Executing transactions</h3>
<p>Transactions can be a bit tricky sometimes. With this interface, we can separate queries and execute a transaction that will be committed in the end (optional, default is to be committed).</p>
<div class="code">
	<pre>// When adding a new user to the database
// We want to take the id as generated by the next auto_increment value from the database

// Create the query/transaction
$query = "INSERT INTO users (username, password) VALUES ({username}, {password});";
$query .= "SELECT last_insert_id() as id;";

// Set attributes values as a key-value array
$attributes = array();
$attributes['username'] = "John";
$attributes['password'] = "asdQWE!@#";

// Execute the query given an array of attributes and get the result of the last query
$result = $dbc-&gt;execute($query, $attributes);

// If we fetch the result, we will get the user id
if ($result)
{
	$userInfo = $dbc-&gt;fetch($result);
	$userID = $userInfo['id'];
}</pre>
</div>
<h3>Catching and handling errors</h3>
<p>During a query or a transaction, something could go wrong. In this case, the interface will return FALSE and will store the error internally. In case of transactions, a rollback is performed.</p>
<div class="code">
	<pre>// Trying to assign a value to a string without quotes
// Could result to an error

// Create the query
$query = "UPDATE users SET password = {password} WHERE username = '{username}';";

// Set attributes values as a key-value array
$attributes = array();
$attributes['username'] = "John";
$attributes['password'] = "^&amp;*vbnWER";

// Execute the query given an array of attributes and get the result of the last query
$result = $dbc-&gt;execute($query, $attributes);
if (!$result)
{
	// Something went wrong, get the error
	$error = $dbc-&gt;getError();
	
	// Log the error somewhere
}</pre>
</div>
</div>
<div class="footer"><p class="updated">Document updated 20 May, 2015 at 12:40</p></div>
</div></body></html>
